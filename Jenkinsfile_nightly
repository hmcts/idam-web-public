#!groovy

properties([
    pipelineTriggers([cron('10 21 * * *')]),
    parameters([
        string(name: 'URL_TO_TEST', defaultValue: 'https://idam-web-public-idam-aat.service.core-compute-idam-aat.internal', description: 'The URL you want to run these tests against'),
        string(name: 'API_URL_TO_TEST', defaultValue: 'https://idam-api-idam-aat.service.core-compute-idam-aat.internal', description: 'The API URL you want to run these tests against '),
        string(name: 'SAUCE_KEY', defaultValue: '101a14e3-0458-4927-a968-129adbf18152', description: 'Sauce key'),
        string(name: 'SAUCE_USERNAME', defaultValue: 'sudhasane', description: 'Sauce User name'),
        string(name: 'REFORM_TUNNEL', defaultValue: 'reformtunnel', description: 'Tunnel identifier'),
    ])
])
@Library("Infrastructure") _

def type = "java"
def product = "idam"
def component = "idam-web-public"
def secrets = [
    'idam-idam-aat':[
        secret('smoke-test-user-username', 'SMOKE_TEST_USER_USERNAME'),
        secret('smoke-test-user-password', 'SMOKE_TEST_USER_PASSWORD'),
        secret('notify-api-key', 'NOTIFY_API_KEY')
    ]
]
static LinkedHashMap<String, Object> secret(String secretName, String envVar) {
    [$class     : 'AzureKeyVaultSecret',
     secretType : 'Secret',
     name       : secretName,
     version    : '',
     envVariable: envVar
    ]
}
withNightlyPipeline(type, product, component) {
    env.TEST_URL = params.URL_TO_TEST
    env.IDAMAPI = params.API_URL_TO_TEST
    env.TUNNEL_IDENTIFIER = params.REFORM_TUNNEL
    env.SAUCE_ACCESS_KEY = params.SAUCE_KEY
    env.SAUCE_USERNAME = params.SAUCE_USERNAME
    loadVaultSecrets(secrets)

    //enableSecurityScan()

    //enableMutationTest()

    enableFullFunctionalTest()

    enableCrossBrowserTest()


    after('fullFunctionalTest') {

        sh "./gradlew smoke"

        archiveArtifacts '**/build/test-results/**/*'

        publishHTML target: [
            allowMissing         : true,
            alwaysLinkToLastBuild: true,
            keepAll              : true,
            reportDir            : "output",
            reportFiles          : "idam-web-public-e2e-result.html",
            reportName           : "IDAM Web public E2E smoke tests result"
        ]

        sh "./gradlew functional"

        archiveArtifacts '**/build/test-results/**/*'

        publishHTML target: [
            allowMissing         : true,
            alwaysLinkToLastBuild: true,
            keepAll              : true,
            reportDir            : "output",
            reportFiles          : "idam-web-public-e2e-result.html",
            reportName           : "IDAM Web public E2E functional tests result"
        ]
    }

    after('crossBrowserTest') {

              try {
                  withSauceConnect("reform_tunnel") {
                      sh "./gradlew functionalSauce"
                      steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'functional-output/**/*'
                  }
              }

              finally {
                      steps.saucePublisher()
                  }

            }

}

//       env.TEST_URL = params.URL_TO_TEST
//        enableSecurityScan()
//
//        sh "./gradlew --no-daemon --init-script init.gradle pitest"
//
//        archiveArtifacts '**/build/reports/pitest/**/*'
//
//        withSonarQubeEnv("SonarQube") {
//            sh "./gradlew --info sonarqube"
//        }


