#!groovy

@Library("Infrastructure@SIDM_increase_FuncTest_timout")

def type = "java"
def product = "idam"
def component = "web-public"
def subscription = "sandbox"
def secrets = [
    'idam-idam-${env}': [
        secret('smoke-test-user-username', 'SMOKE_TEST_USER_USERNAME'),
        secret('smoke-test-user-password', 'SMOKE_TEST_USER_PASSWORD'),
        secret('notify-api-key', 'NOTIFY_API_KEY')
    ]
]

properties([
    parameters([
        choice(name: 'ENVIRONMENT', choices: 'idam-sandbox\nidam-saat\nidam-sprod', description: 'Environment where code should be build and deployed')
    ])
])

static LinkedHashMap<String, Object> secret(String secretName, String envVar) {
    [$class     : 'AzureKeyVaultSecret',
     secretType : 'Secret',
     name       : secretName,
     version    : '',
     envVariable: envVar
    ]
}

withParameterizedPipeline(type, product, component, params.ENVIRONMENT, subscription){
  loadVaultSecrets(secrets)
  disableLegacyDeployment()

  after('test') {
    publishHTML target: [
        allowMissing         : true,
        alwaysLinkToLastBuild: true,
        keepAll              : true,
        reportDir            : "build/reports/jacoco",
        reportFiles          : "index.html",
        reportName           : "IdAM Web Public Code Coverage Report"
    ]

    publishHTML target: [
        allowMissing         : true,
        alwaysLinkToLastBuild: true,
        keepAll              : true,
        reportDir            : "build/reports/pmd",
        reportFiles          : "main.html",
        reportName           : "IdAM Web Public PMD Report"
    ]
  }
}